---
import Layout from "../layouts/Layout.astro";
import { glossary } from "../data/glossary";

const items = [...glossary].sort((a, b) => a.name.localeCompare(b.name, "ru"));

const categories = Array.from(new Set(glossary.map((g) => g.category))).sort();
---

<Layout title="–ì–ª–æ—Å—Å–∞—Ä–∏–π –ø—Ä–∞–≤–∏–ª">
    <div class="content">
        <h1>–ì–ª–æ—Å—Å–∞—Ä–∏–π –ø—Ä–∞–≤–∏–ª</h1>

        <div class="glossary-container">
            <div class="left-column">
                <div class="controls">
                    <div class="search-input-container">
                        <input
                            id="glossary-search"
                            class="search-input"
                            type="text"
                            placeholder="–ü–æ–∏—Å–∫ –ø—Ä–∞–≤–∏–ª..."
                        />
                        <button
                            id="clear-search"
                            class="clear-search-button"
                            style="display:none">√ó</button
                        >
                    </div>
                    <button id="filter-button" class="filter-button"
                        >–§–∏–ª—å—Ç—Ä—ã <span
                            id="filter-count"
                            class="filter-count"
                            style="display:none">0</span
                        ></button
                    >
                </div>

                <div id="filter-popup" class="filter-popup">
                    <div class="filter-content">
                        <div class="filter-header">
                            <h3>–§–∏–ª—å—Ç—Ä—ã</h3>
                            <button class="close-button" aria-label="–ó–∞–∫—Ä—ã—Ç—å"
                                >√ó</button
                            >
                        </div>

                        <div class="filter-section">
                            <h4>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h4>
                            <div class="checkbox-group">
                                {
                                    categories.map((cat) => (
                                        <label class="checkbox-label">
                                            <input
                                                type="checkbox"
                                                name="category"
                                                value={cat}
                                            />
                                            {cat}
                                        </label>
                                    ))
                                }
                            </div>
                        </div>

                        <div class="filter-actions">
                            <button id="apply-filters" class="reset-button"
                                >–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button
                            >
                            <button id="reset-filters" class="reset-button"
                                >–°–±—Ä–æ—Å–∏—Ç—å</button
                            >
                        </div>
                    </div>
                </div>

                <div id="rules-list" class="rules-list">
                    {
                        items.map((rule) => (
                            <div
                                class="rule-card"
                                data-id={rule.id}
                                tabindex="0"
                            >
                                <div class="rule-name">{rule.name}</div>
                                <div class="rule-cat">{rule.category}</div>
                            </div>
                        ))
                    }
                </div>
            </div>

            <div class="right-column">
                <div id="details-area" class="details-area">
                    <div class="details-empty">
                        –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª–æ —Å–ª–µ–≤–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    </div>
                </div>
            </div>
        </div>
    </div>
</Layout>

<div
    id="glossary-data"
    data-json={JSON.stringify(glossary)}
    style="display:none"
>
</div>

<script type="module">
    const GLOSSARY = JSON.parse(
        document.getElementById("glossary-data").dataset.json || "[]",
    );

    const detailsArea = document.getElementById("details-area");
    const searchInput = document.getElementById("glossary-search");
    const clearSearch = document.getElementById("clear-search");
    const filterButton = document.getElementById("filter-button");
    const filterPopup = document.getElementById("filter-popup");
    const applyFilters = document.getElementById("apply-filters");
    const resetFilters = document.getElementById("reset-filters");
    const filterCountEl = document.getElementById("filter-count");

    let pinned = JSON.parse(localStorage.getItem("glossaryPinned") || "[]");
    pinned = Array.isArray(pinned) ? pinned.slice(0, 2) : [];

    function renderList(filterText = "", categories = []) {
        const nodes = Array.from(document.querySelectorAll(".rule-card"));
        nodes.forEach((n) => {
            const id = n.dataset.id;
            const rule = GLOSSARY.find((r) => r.id === id);
            if (!rule) return;
            let visible = true;
            if (filterText) {
                visible = (
                    (rule.name || "") +
                    " " +
                    (rule.nameEn || "") +
                    " " +
                    (rule.description || "")
                )
                    .toLowerCase()
                    .includes(filterText.toLowerCase());
            }
            if (categories.length && !categories.includes(rule.category))
                visible = false;
            n.style.display = visible ? "" : "none";
            n.classList.remove("active");
        });
    }

    function showRule(id, pushState = true) {
        const rule = GLOSSARY.find((r) => r.id === id);
        if (!rule) return;
        const pinnedToShow = pinned.filter((pid) => pid !== id).slice(0, 2);
        detailsArea.innerHTML = "";

        const activeCard = createDetailCard(rule, true);
        detailsArea.appendChild(activeCard);

        pinnedToShow.forEach((pid) => {
            const r = GLOSSARY.find((x) => x.id === pid);
            if (r) detailsArea.appendChild(createDetailCard(r, false));
        });

        document
            .querySelectorAll(".rule-card")
            .forEach((c) => c.classList.toggle("active", c.dataset.id === id));

        if (pushState) {
            // Use hash-based navigation to avoid server 404s for /glossary/:id on reload
            const url = `/glossary#${encodeURIComponent(id)}`;
            history.pushState({ id }, "", url);
        }
    }

    function createDetailCard(rule, isActive) {
        const wrap = document.createElement("div");
        wrap.className =
            "detail-card" + (isActive ? " active-detail" : " pinned-detail");
        const header = document.createElement("div");
        header.className = "detail-header";
        const h = document.createElement("h3");
        h.textContent = rule.name;
        header.appendChild(h);
        const catEl = document.createElement("div");
        catEl.className = "detail-cat header-cat";
        catEl.textContent = rule.category;
        header.appendChild(catEl);

        const pinBtn = document.createElement("button");
        pinBtn.className = "pin-btn";
        pinBtn.textContent = pinned.includes(rule.id) ? "üìå" : "üìç";
        pinBtn.title = pinned.includes(rule.id) ? "–û—Ç–∫—Ä–µ–ø–∏—Ç—å" : "–ó–∞–∫—Ä–µ–ø–∏—Ç—å";
        pinBtn.addEventListener("click", () => {
            togglePin(rule.id);
            showRule(rule.id, false);
        });
        header.appendChild(pinBtn);
        wrap.appendChild(header);
        const desc = document.createElement("div");
        desc.className = "detail-desc";
        if (rule.html) desc.innerHTML = rule.html;
        else desc.textContent = rule.description || "";
        wrap.appendChild(desc);
        return wrap;
    }

    function togglePin(id) {
        const idx = pinned.indexOf(id);
        if (idx !== -1) {
            pinned.splice(idx, 1);
        } else {
            if (pinned.length >= 2) {
                pinned.pop();
            }
            pinned.unshift(id);
        }
        localStorage.setItem("glossaryPinned", JSON.stringify(pinned));
    }

    // Click on list
    document.querySelectorAll(".rule-card").forEach((card) => {
        card.addEventListener("click", () => showRule(card.dataset.id));
        card.addEventListener("keydown", (e) => {
            if (e.key === "Enter") showRule(card.dataset.id);
        });
    });

    // Search
    searchInput.addEventListener("input", () => {
        const v = searchInput.value.trim();
        clearSearch.style.display = v ? "inline" : "none";
        renderList(v, getSelectedCategories());
    });
    clearSearch.addEventListener("click", () => {
        searchInput.value = "";
        clearSearch.style.display = "none";
        renderList("", getSelectedCategories());
    });

    // Filters
    function closePopup(e) {
        if (e.target === filterPopup) filterPopup.classList.remove("show");
    }

    filterButton.addEventListener("click", () => {
        filterPopup.classList.toggle("show");
    });
    applyFilters.addEventListener("click", () => {
        filterPopup.classList.remove("show");
        renderList(searchInput.value.trim(), getSelectedCategories());
        updateFilterCount();
    });
    resetFilters.addEventListener("click", () => {
        document
            .querySelectorAll('input[name="category"]')
            .forEach((i) => (i.checked = false));
        renderList(searchInput.value.trim(), []);
        updateFilterCount();
    });
    // close when clicking outside
    filterPopup.addEventListener("click", closePopup);
    const closeBtn = filterPopup.querySelector(".close-button");
    if (closeBtn)
        closeBtn.addEventListener("click", () =>
            filterPopup.classList.remove("show"),
        );

    function getSelectedCategories() {
        return Array.from(
            document.querySelectorAll('input[name="category"]:checked'),
        ).map((i) => i.value);
    }
    function updateFilterCount() {
        const n = getSelectedCategories().length;
        filterCountEl.textContent = n;
        filterCountEl.style.display = n ? "inline" : "none";
    }

    const pathParts = window.location.pathname.split("/").filter(Boolean);
    // If URL contains hash (#id) open that rule on load. Fallback: support /glossary/:id
    const hashId = decodeURIComponent((window.location.hash || '').replace(/^#/, '')) || null;
    if (hashId) {
        setTimeout(() => showRule(hashId, false), 20);
    } else if (pathParts[0] === "glossary" && pathParts[1]) {
        setTimeout(() => showRule(pathParts[1], false), 20);
    }

    renderList();
</script>

<style>
    .glossary-container {
        display: flex;
        gap: 1rem;
    }
    .left-column {
        width: 40%;
    }
    .right-column {
        width: 60%;
    }
    .controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    .search-input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--card-border);
        border-radius: 4px;
    }
    .filter-button {
        padding: 0.4rem 0.6rem;
        border: 1px solid var(--card-border);
        background: var(--card-bg);
        cursor: pointer;
    }
    .rules-list {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.6rem;
    }
    .rule-card {
        background: var(--card-bg);
        padding: 0.8rem;
        border: 1px solid var(--card-border);
        border-radius: 6px;
        cursor: pointer;
    }
    .rule-card.active {
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        border-color: var(--primary);
    }
    .rule-name {
        font-weight: 600;
        color: var(--primary);
    }
    .rule-cat {
        font-size: 0.85rem;
        opacity: 0.8;
        margin-top: 0.4rem;
    }

    .details-area {
        background: var(--card-bg);
        padding: 1rem;
        border: 1px solid var(--card-border);
        border-radius: 6px;
        min-height: 200px;
    }
    .detail-card {
        padding: 0.75rem;
        border-bottom: 1px solid var(--card-border);
    }
    .detail-card:last-child {
        border-bottom: none;
    }
    .detail-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .detail-header h3 {
        margin: 0;
        color: var(--primary);
        flex: 1;
    }
    .detail-header {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: nowrap;
    }
    .header-cat {
        margin-left: 0.5rem;
        color: var(--text);
        opacity: 0.85;
        background: var(--background);
        padding: 0.15rem 0.45rem;
        border-radius: 0.35rem;
        font-size: 0.85rem;
        border: 1px solid var(--card-border);
    }
    .pin-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 1.05rem;
        margin-left: 0.5rem;
        flex: 0 0 auto;
    }
    .detail-cat {
        font-size: 0.85rem;
        opacity: 0.8;
        margin: 0.5rem 0;
    }
    .detail-desc {
        margin-top: 0.5rem;
        white-space: pre-wrap;
        line-height: 1.6;
        font-size: 0.97rem;
        color: var(--text);
    }

    .copy-tooltip {
        display: none;
    }

    /* Filter popup styles (copied from magic-items) */
    .filter-popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }

    .filter-popup.show {
        display: block;
    }

    .filter-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--card-bg);
        padding: 1.25rem;
        border-radius: 0.5rem;
        min-width: 420px;
        max-width: 95%;
        max-height: 90vh;
        overflow-y: auto;
        border: 1px solid var(--card-border);
        box-shadow: var(--card-shadow);
    }

    .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--card-border);
    }

    .close-button {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0.25rem;
    }

    .filter-section {
        margin-bottom: 1rem;
    }

    .filter-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
        padding-top: 0.5rem;
        border-top: 1px solid var(--card-border);
    }

    .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        max-height: 40vh;
        overflow: auto;
        padding: 0.25rem;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 0.25rem;
    }

    .reset-button {
        padding: 0.6rem 0.75rem;
        background: var(--background);
        border: 1px solid var(--card-border);
        border-radius: 0.375rem;
        cursor: pointer;
    }

    /* Rich HTML content styles for glossary descriptions */
    .detail-desc table {
        width: 100%;
        margin: 1rem 0;
        border-collapse: collapse;
        background: var(--card-bg);
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .detail-desc th,
    .detail-desc td {
        padding: 0.75rem;
        border: 1px solid var(--card-border);
        text-align: left;
        vertical-align: top;
    }

    .detail-desc th {
        background: var(--background);
        font-weight: 600;
    }

    .detail-desc tr:nth-child(even) {
        background: var(--background);
    }

    .detail-desc pre,
    .detail-desc code {
        background: var(--background);
        padding: 0.6rem;
        border-radius: 0.375rem;
        display: block;
        overflow: auto;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', 'Courier New', monospace;
        font-size: 0.9rem;
    }

    /* Make code blocks slightly more distinct */
    .detail-desc pre {
        border: 1px solid var(--card-border);
        background: color-mix(in srgb, var(--background) 85%, black 5%);
    }

    .detail-desc blockquote {
        margin: 0.6rem 0;
        padding: 0.6rem 1rem;
        border-left: 4px solid var(--card-border);
        background: transparent;
        color: var(--text);
        opacity: 0.95;
    }

    .detail-desc a {
        color: var(--primary);
        text-decoration: underline;
    }

    .detail-desc ul,
    .detail-desc ol {
        margin: 0.5rem 0 0.5rem 1.25rem;
    }

    .detail-desc p { margin: 0 0 0.75rem 0 }
</style>
